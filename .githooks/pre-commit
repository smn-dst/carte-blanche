#!/bin/sh

# =============================================================================
# Hook pre-commit : vÃ©rifie la qualitÃ© du code AVANT chaque commit
# Retourne 0 = OK, autre = bloque le commit
# =============================================================================

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "=========================================="
echo "  ðŸ” VÃ©rifications pre-commit en cours..."
echo "=========================================="
echo ""

# RÃ©cupÃ©rer uniquement les fichiers PHP staged (pas tout le projet)
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$')
STAGED_TWIG_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.twig$')

HAS_ERRORS=0

# -----------------------------------------------------------------------------
# 1. VÃ©rifier qu'il n'y a pas de dump(), dd(), var_dump() dans le code PHP
# -----------------------------------------------------------------------------
if [ -n "$STAGED_PHP_FILES" ]; then
    echo "${YELLOW}[1/4] Recherche de debug oubliÃ© (PHP)...${NC}"

    for FILE in $STAGED_PHP_FILES; do
        # VÃ©rifier dans le contenu staged (pas le fichier sur disque)
        DUMP_FOUND=$(git diff --cached -- "$FILE" | grep -E '^\+.*\b(dump|dd|var_dump|print_r|die|exit)\s*\(' | grep -v '^\+\+\+')

        if [ -n "$DUMP_FOUND" ]; then
            echo "${RED}  âœ— Debug trouvÃ© dans $FILE :${NC}"
            echo "$DUMP_FOUND"
            HAS_ERRORS=1
        fi
    done

    if [ $HAS_ERRORS -eq 0 ]; then
        echo "${GREEN}  âœ“ Aucun debug oubliÃ©${NC}"
    fi
fi

# -----------------------------------------------------------------------------
# 2. VÃ©rifier qu'il n'y a pas de console.log() dans le JS/Twig
# -----------------------------------------------------------------------------
ALL_FRONT_FILES="$STAGED_JS_FILES $STAGED_TWIG_FILES"
if [ -n "$(echo "$ALL_FRONT_FILES" | tr -d '[:space:]')" ]; then
    echo "${YELLOW}[2/4] Recherche de console.log oubliÃ© (JS/Twig)...${NC}"

    for FILE in $ALL_FRONT_FILES; do
        [ -z "$FILE" ] && continue
        CONSOLE_FOUND=$(git diff --cached -- "$FILE" | grep -E '^\+.*console\.(log|debug|warn|error|info)\s*\(' | grep -v '^\+\+\+')

        if [ -n "$CONSOLE_FOUND" ]; then
            echo "${RED}  âœ— console.log trouvÃ© dans $FILE :${NC}"
            echo "$CONSOLE_FOUND"
            HAS_ERRORS=1
        fi
    done

    if [ $HAS_ERRORS -eq 0 ]; then
        echo "${GREEN}  âœ“ Aucun console.log oubliÃ©${NC}"
    fi
else
    echo "${YELLOW}[2/4] Pas de fichiers JS/Twig modifiÃ©s, skip.${NC}"
fi

# -----------------------------------------------------------------------------
# 3. PHP-CS-Fixer (style du code PHP) - uniquement sur les fichiers staged
# -----------------------------------------------------------------------------
if [ -n "$STAGED_PHP_FILES" ]; then
    echo "${YELLOW}[3/4] VÃ©rification du style PHP (PHP-CS-Fixer)...${NC}"

    # Adapter le chemin selon l'installation
    if [ -f "./php-cs-fixer.phar" ]; then
        CS_FIXER="php ./php-cs-fixer.phar"
    elif [ -f "./vendor/bin/php-cs-fixer" ]; then
        CS_FIXER="./vendor/bin/php-cs-fixer"
    else
        echo "${YELLOW}  âš  PHP-CS-Fixer non trouvÃ©, skip.${NC}"
        CS_FIXER=""
    fi

    if [ -n "$CS_FIXER" ]; then
        # Exclure les fichiers gÃ©nÃ©rÃ©s (assets/vendor, etc.)
        CS_FIXER_FILES=""
        for F in $STAGED_PHP_FILES; do
            case "$F" in
                assets/vendor/*) ;;
                *) CS_FIXER_FILES="$CS_FIXER_FILES $F" ;;
            esac
        done
        # Lancer sur les fichiers staged (hors exclus)
        FIXER_OUTPUT=""
        for FILE in $CS_FIXER_FILES; do
            [ -z "$FILE" ] && continue
            RESULT=$($CS_FIXER fix "$FILE" --dry-run --diff 2>&1)
            if [ $? -ne 0 ]; then
                FIXER_OUTPUT="${FIXER_OUTPUT}\n${RESULT}"
                HAS_ERRORS=1
            fi
        done

        if [ -n "$FIXER_OUTPUT" ]; then
            echo "${RED}  âœ— Erreurs de style dÃ©tectÃ©es !${NC}"
            echo "$FIXER_OUTPUT"
            echo ""
            echo "${YELLOW}  ðŸ’¡ Pour corriger automatiquement : $CS_FIXER fix${NC}"
        else
            echo "${GREEN}  âœ“ Style PHP OK${NC}"
        fi
    fi
else
    echo "${YELLOW}[3/4] Pas de fichiers PHP modifiÃ©s, skip.${NC}"
fi

# -----------------------------------------------------------------------------
# 4. PHPStan (analyse statique) - uniquement sur les fichiers staged
# -----------------------------------------------------------------------------
if [ -n "$STAGED_PHP_FILES" ]; then
    echo "${YELLOW}[4/4] Analyse statique PHPStan...${NC}"

    if [ -f "./vendor/bin/phpstan" ]; then
        PHPSTAN="./vendor/bin/phpstan"
    else
        echo "${YELLOW}  âš  PHPStan non trouvÃ© dans vendor, skip.${NC}"
        PHPSTAN=""
    fi

    if [ -n "$PHPSTAN" ]; then
        # Ne passer que les fichiers dans src/ ou tests/ (exclut les configs type .php-cs-fixer.dist.php)
        PHPSTAN_FILES=""
        for F in $STAGED_PHP_FILES; do
            case "$F" in
                src/*|tests/*) PHPSTAN_FILES="$PHPSTAN_FILES $F" ;;
            esac
        done
        if [ -n "$(echo "$PHPSTAN_FILES" | tr -d '[:space:]')" ]; then
            $PHPSTAN analyse --memory-limit=512M --no-progress $PHPSTAN_FILES 2>&1
            if [ $? -ne 0 ]; then
                echo "${RED}  âœ— Erreurs PHPStan dÃ©tectÃ©es !${NC}"
                HAS_ERRORS=1
            else
                echo "${GREEN}  âœ“ Analyse statique OK${NC}"
            fi
        else
            echo "${GREEN}  âœ“ Aucun fichier PHP dans src/ ou tests/, skip PHPStan${NC}"
        fi
    fi
else
    echo "${YELLOW}[4/4] Pas de fichiers PHP modifiÃ©s, skip.${NC}"
fi

# -----------------------------------------------------------------------------
# RÃ©sultat final
# -----------------------------------------------------------------------------
echo ""
if [ $HAS_ERRORS -ne 0 ]; then
    echo "=========================================="
    echo "${RED}  âœ— COMMIT BLOQUÃ‰ - Corrige les erreurs ci-dessus${NC}"
    echo "=========================================="
    echo ""
    echo "${YELLOW}  Pour bypass en urgence : git commit --no-verify${NC}"
    echo ""
    exit 1
fi

echo "=========================================="
echo "${GREEN}  âœ“ Toutes les vÃ©rifications sont passÃ©es${NC}"
echo "=========================================="
echo ""
exit 0
