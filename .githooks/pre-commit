#!/bin/sh

# =============================================================================
# Hook pre-commit : v√©rifie la qualit√© du code AVANT chaque commit
# Retourne 0 = OK, autre = bloque le commit
# =============================================================================

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "=========================================="
echo "  üîç V√©rifications pre-commit en cours..."
echo "=========================================="
echo ""

# R√©cup√©rer uniquement les fichiers PHP staged (pas tout le projet)
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$')
STAGED_TWIG_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.twig$')

HAS_ERRORS=0

# -----------------------------------------------------------------------------
# 1. V√©rifier qu'il n'y a pas de dump(), dd(), var_dump() dans le code PHP
# -----------------------------------------------------------------------------
if [ -n "$STAGED_PHP_FILES" ]; then
    echo "${YELLOW}[1/4] Recherche de debug oubli√© (PHP)...${NC}"

    for FILE in $STAGED_PHP_FILES; do
        # V√©rifier dans le contenu staged (pas le fichier sur disque)
        DUMP_FOUND=$(git diff --cached -- "$FILE" | grep -E '^\+.*\b(dump|dd|var_dump|print_r|die|exit)\s*\(' | grep -v '^\+\+\+')

        if [ -n "$DUMP_FOUND" ]; then
            echo "${RED}  ‚úó Debug trouv√© dans $FILE :${NC}"
            echo "$DUMP_FOUND"
            HAS_ERRORS=1
        fi
    done

    if [ $HAS_ERRORS -eq 0 ]; then
        echo "${GREEN}  ‚úì Aucun debug oubli√©${NC}"
    fi
fi

# -----------------------------------------------------------------------------
# 2. V√©rifier qu'il n'y a pas de console.log() dans le JS/Twig
# -----------------------------------------------------------------------------
ALL_FRONT_FILES="$STAGED_JS_FILES $STAGED_TWIG_FILES"
if [ -n "$(echo "$ALL_FRONT_FILES" | tr -d '[:space:]')" ]; then
    echo "${YELLOW}[2/4] Recherche de console.log oubli√© (JS/Twig)...${NC}"

    for FILE in $ALL_FRONT_FILES; do
        [ -z "$FILE" ] && continue
        CONSOLE_FOUND=$(git diff --cached -- "$FILE" | grep -E '^\+.*console\.(log|debug|warn|error|info)\s*\(' | grep -v '^\+\+\+')

        if [ -n "$CONSOLE_FOUND" ]; then
            echo "${RED}  ‚úó console.log trouv√© dans $FILE :${NC}"
            echo "$CONSOLE_FOUND"
            HAS_ERRORS=1
        fi
    done

    if [ $HAS_ERRORS -eq 0 ]; then
        echo "${GREEN}  ‚úì Aucun console.log oubli√©${NC}"
    fi
else
    echo "${YELLOW}[2/4] Pas de fichiers JS/Twig modifi√©s, skip.${NC}"
fi

# -----------------------------------------------------------------------------
# 3. PHP-CS-Fixer (style du code PHP) - uniquement sur les fichiers staged
# -----------------------------------------------------------------------------
if [ -n "$STAGED_PHP_FILES" ]; then
    echo "${YELLOW}[3/4] V√©rification du style PHP (PHP-CS-Fixer)...${NC}"

    # Adapter le chemin selon l'installation
    if [ -f "./php-cs-fixer.phar" ]; then
        CS_FIXER="php ./php-cs-fixer.phar"
    elif [ -f "./vendor/bin/php-cs-fixer" ]; then
        CS_FIXER="./vendor/bin/php-cs-fixer"
    else
        echo "${YELLOW}  ‚ö† PHP-CS-Fixer non trouv√©, skip.${NC}"
        CS_FIXER=""
    fi

    if [ -n "$CS_FIXER" ]; then
        # Lancer sur les fichiers staged uniquement
        FIXER_OUTPUT=""
        for FILE in $STAGED_PHP_FILES; do
            RESULT=$($CS_FIXER fix "$FILE" --dry-run --diff 2>&1)
            if [ $? -ne 0 ]; then
                FIXER_OUTPUT="${FIXER_OUTPUT}\n${RESULT}"
                HAS_ERRORS=1
            fi
        done

        if [ -n "$FIXER_OUTPUT" ]; then
            echo "${RED}  ‚úó Erreurs de style d√©tect√©es !${NC}"
            echo "$FIXER_OUTPUT"
            echo ""
            echo "${YELLOW}  üí° Pour corriger automatiquement : $CS_FIXER fix${NC}"
        else
            echo "${GREEN}  ‚úì Style PHP OK${NC}"
        fi
    fi
else
    echo "${YELLOW}[3/4] Pas de fichiers PHP modifi√©s, skip.${NC}"
fi

# -----------------------------------------------------------------------------
# 4. PHPStan (analyse statique) - uniquement sur les fichiers staged
# -----------------------------------------------------------------------------
if [ -n "$STAGED_PHP_FILES" ]; then
    echo "${YELLOW}[4/4] Analyse statique PHPStan...${NC}"

    if [ -f "./vendor/bin/phpstan" ]; then
        PHPSTAN="./vendor/bin/phpstan"
    else
        echo "${YELLOW}  ‚ö† PHPStan non trouv√© dans vendor, skip.${NC}"
        PHPSTAN=""
    fi

    if [ -n "$PHPSTAN" ]; then
        $PHPSTAN analyse --memory-limit=512M --no-progress $STAGED_PHP_FILES 2>&1

        if [ $? -ne 0 ]; then
            echo "${RED}  ‚úó Erreurs PHPStan d√©tect√©es !${NC}"
            HAS_ERRORS=1
        else
            echo "${GREEN}  ‚úì Analyse statique OK${NC}"
        fi
    fi
else
    echo "${YELLOW}[4/4] Pas de fichiers PHP modifi√©s, skip.${NC}"
fi

# -----------------------------------------------------------------------------
# R√©sultat final
# -----------------------------------------------------------------------------
echo ""
if [ $HAS_ERRORS -ne 0 ]; then
    echo "=========================================="
    echo "${RED}  ‚úó COMMIT BLOQU√â - Corrige les erreurs ci-dessus${NC}"
    echo "=========================================="
    echo ""
    echo "${YELLOW}  Pour bypass en urgence : git commit --no-verify${NC}"
    echo ""
    exit 1
fi

echo "=========================================="
echo "${GREEN}  ‚úì Toutes les v√©rifications sont pass√©es${NC}"
echo "=========================================="
echo ""
exit 0
