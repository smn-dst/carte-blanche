name: CI

on:
  push:
    branches: [dev, main, tests]
  pull_request:
    branches: [dev, main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ─── QUALITY ─────────────

  lint-php:
    name: "PHP Quality (CS-Fixer + PHPStan)"
    runs-on: ubuntu-latest
    env:
      APP_ENV: test
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction
      - run: composer run cs-check
      - run: composer run phpstan

  lint-js:
    name: "JS Quality (ESLint)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci
      - run: npm run lint

  lint-twig:
    name: "Twig & YAML Lint"
    runs-on: ubuntu-latest
    env:
      APP_ENV: test
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction
      - run: php bin/console lint:twig templates/
      - run: php bin/console lint:yaml config/
      - run: php bin/console lint:container

  # ─── TESTS ────────────────

  unit-tests:
    name: "Tests unitaires"
    needs: [lint-php]
    runs-on: ubuntu-latest
    env:
      APP_ENV: test
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction
      - run: composer run phpunit:unit

  functional-tests:
    name: "Tests fonctionnels"
    needs: [lint-php]
    runs-on: ubuntu-latest
    env:
      APP_ENV: test
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction
      - run: composer run phpunit:functional

  # ─── E2E ───────────────────

  e2e:
    name: "Tests E2E (Cypress)"
    needs: [unit-tests, functional-tests, lint-js]
    runs-on: ubuntu-latest
    env:
      APP_ENV: test
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction
      - run: npm ci

      - name: Build assets
        run: npm run build

      - name: Demarrer le serveur
        run: |
          php -S 127.0.0.1:8000 -t public > /dev/null 2>&1 &
          sleep 3

      - name: Cypress
        run: npx cypress run

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots/

  # ─── BUILD (main) ───────────────────

  build:
    name: "Build production"
    if: github.ref == 'refs/heads/main'
    needs: [e2e, lint-twig]
    runs-on: ubuntu-latest
    env:
      APP_ENV: prod
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: composer install --no-progress --no-dev --optimize-autoloader
      - run: npm ci
      - run: npm run build

      - name: Cache warmup
        run: php bin/console cache:warmup --env=prod --no-debug

      - run: echo "Build prod OK — prêt pour le déploiement"