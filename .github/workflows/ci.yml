name: CI

on:
  push:
    branches: [dev, main, tests]
  pull_request:
    branches: [dev, main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_ENV: test
  PHP_VERSION: "8.4"
  NODE_VERSION: 22

jobs:

  # ─── SETUP ───────────────

  setup:
    name: "Install dependencies"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2, php-cs-fixer

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Cache assets vendor (importmap)
        uses: actions/cache@v4
        with:
          path: assets/vendor
          key: assets-vendor-${{ hashFiles('composer.lock') }}-${{ hashFiles('package-lock.json') }}
          restore-keys: assets-vendor-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction --no-scripts
      - run: npm ci
      - run: php bin/console importmap:install

  # ─── QUALITY ──────────────

  lint-php:
    name: "PHP Quality (CS-Fixer + PHPStan)"
    needs: [setup]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2, php-cs-fixer

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction --no-scripts
      - run: chmod +x vendor/bin/*

      - run: composer run cs-check
      - run: composer run phpstan

  lint-js:
    name: "JS Quality (ESLint)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci
      - run: npm run lint

  lint-twig:
    name: "Twig & YAML Lint"
    needs: [setup]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: amqp, intl, pdo_pgsql

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction --no-scripts
      - run: php bin/console lint:twig templates/
      - run: php bin/console lint:yaml config/
      - run: php bin/console lint:container

  # ─── TESTS ───────────────────────

  unit-tests:
    name: "Tests unitaires"
    needs: [lint-php, lint-js, lint-twig]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: amqp, intl, pdo_pgsql

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction --no-scripts
      - run: composer run phpunit:unit

  functional-tests:
    name: "Tests fonctionnels"
    needs: [lint-php, lint-js, lint-twig]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: amqp, intl, pdo_pgsql

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Cache assets vendor (importmap)
        uses: actions/cache@v4
        with:
          path: assets/vendor
          key: assets-vendor-${{ hashFiles('composer.lock') }}-${{ hashFiles('package-lock.json') }}
          restore-keys: assets-vendor-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction --no-scripts
      - run: php bin/console importmap:install
      - run: chmod +x vendor/bin/*
      - run: composer run phpunit:functional

  # ─── E2E ─────────────────────

  e2e:
    name: "Tests E2E (Cypress)"
    needs: [lint-php, lint-js, lint-twig]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: amqp, intl, pdo_pgsql

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Cache Cypress
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ hashFiles('package-lock.json') }}

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Cache assets vendor (importmap)
        uses: actions/cache@v4
        with:
          path: assets/vendor
          key: assets-vendor-${{ hashFiles('composer.lock') }}-${{ hashFiles('package-lock.json') }}
          restore-keys: assets-vendor-

      - run: npm ci
      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction --no-scripts
      - run: php bin/console importmap:install

      - name: Demarrer le serveur
        run: |
          php -S 127.0.0.1:8888 -t public > /dev/null 2>&1 &
          sleep 3

      - name: Cypress
        run: npx cypress run

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots/

  # ─── BUILD (main) ────────────────

  build:
    name: "Build production"
    if: github.ref == 'refs/heads/main'
    needs: [unit-tests, functional-tests, e2e]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: amqp, intl, pdo_pgsql
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - run: cp .env.test .env
      - run: composer install --no-progress --no-interaction --no-dev --optimize-autoloader --no-scripts
      - run: php bin/console cache:warmup --env=prod --no-debug

      - run: echo "Build prod OK"